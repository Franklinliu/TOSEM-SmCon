from web3 import Web3

web3 = Web3(Web3.HTTPProvider(f'HTTP://127.0.0.1:8545'))  

contract_abi = [{"constant":False,"inputs":[],"name":"Complete","outputs":[],"payable":False,"stateMutability":"nonpayable","type":"function"},{"constant":True,"inputs":[],"name":"ComplianceSensorType","outputs":[{"name":"","type":"uint8"}],"payable":False,"stateMutability":"view","type":"function"},{"constant":True,"inputs":[],"name":"MinTemperature","outputs":[{"name":"","type":"int256"}],"payable":False,"stateMutability":"view","type":"function"},{"constant":False,"inputs":[{"name":"newCounterparty","type":"address"}],"name":"TransferResponsibility","outputs":[],"payable":False,"stateMutability":"nonpayable","type":"function"},{"constant":True,"inputs":[],"name":"PreviousCounterparty","outputs":[{"name":"","type":"address"}],"payable":False,"stateMutability":"view","type":"function"},{"constant":True,"inputs":[],"name":"MaxTemperature","outputs":[{"name":"","type":"int256"}],"payable":False,"stateMutability":"view","type":"function"},{"constant":True,"inputs":[],"name":"SupplyChainObserver","outputs":[{"name":"","type":"address"}],"payable":False,"stateMutability":"view","type":"function"},{"constant":True,"inputs":[],"name":"Counterparty","outputs":[{"name":"","type":"address"}],"payable":False,"stateMutability":"view","type":"function"},{"constant":True,"inputs":[],"name":"ComplianceDetail","outputs":[{"name":"","type":"string"}],"payable":False,"stateMutability":"view","type":"function"},{"constant":True,"inputs":[],"name":"SupplyChainOwner","outputs":[{"name":"","type":"address"}],"payable":False,"stateMutability":"view","type":"function"},{"constant":False,"inputs":[{"name":"humidity","type":"int256"},{"name":"temperature","type":"int256"},{"name":"timestamp","type":"int256"}],"name":"IngestTelemetry","outputs":[],"payable":False,"stateMutability":"nonpayable","type":"function"},{"constant":True,"inputs":[],"name":"LastSensorUpdateTimestamp","outputs":[{"name":"","type":"int256"}],"payable":False,"stateMutability":"view","type":"function"},{"constant":True,"inputs":[],"name":"Device","outputs":[{"name":"","type":"address"}],"payable":False,"stateMutability":"view","type":"function"},{"constant":True,"inputs":[],"name":"Owner","outputs":[{"name":"","type":"address"}],"payable":False,"stateMutability":"view","type":"function"},{"constant":True,"inputs":[],"name":"MinHumidity","outputs":[{"name":"","type":"int256"}],"payable":False,"stateMutability":"view","type":"function"},{"constant":True,"inputs":[],"name":"MaxHumidity","outputs":[{"name":"","type":"int256"}],"payable":False,"stateMutability":"view","type":"function"},{"constant":True,"inputs":[],"name":"InitiatingCounterparty","outputs":[{"name":"","type":"address"}],"payable":False,"stateMutability":"view","type":"function"},{"constant":True,"inputs":[],"name":"ComplianceStatus","outputs":[{"name":"","type":"bool"}],"payable":False,"stateMutability":"view","type":"function"},{"constant":True,"inputs":[],"name":"ComplianceSensorReading","outputs":[{"name":"","type":"int256"}],"payable":False,"stateMutability":"view","type":"function"},{"constant":True,"inputs":[],"name":"State","outputs":[{"name":"","type":"uint8"}],"payable":False,"stateMutability":"view","type":"function"},{"inputs":[{"name":"device","type":"address"},{"name":"supplyChainOwner","type":"address"},{"name":"supplyChainObserver","type":"address"},{"name":"minHumidity","type":"int256"},{"name":"maxHumidity","type":"int256"},{"name":"minTemperature","type":"int256"},{"name":"maxTemperature","type":"int256"}],"payable":False,"stateMutability":"nonpayable","type":"constructor"}]

import csv

csv_file1 = "all_txn.csv"

data_column = []

with open(csv_file1, mode="r") as file:
    reader = csv.DictReader(file)
    for row in reader:
        data_column.append(row["Data"])


tx_data = '60806040523480156200001157600080fd5b5060405160e080620013ce833981018060405260e08110156200003357600080fd5b81019080805190602001909291908051906020019092919080519060200190929190805190602001909291908051906020019092919080519060200190929190805190602001909291905050506001600d60006101000a81548160ff0219169083151502179055507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff600c8190555033600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600060016101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555086600460006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555085600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555084600660006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555083600781905550826008819055508160098190555080600a8190555060008060006101000a81548160ff02191690836003811115620002c757fe5b02179055506040805190810160405280600381526020017f4e2f410000000000000000000000000000000000000000000000000000000000815250600e90805190602001906200031992919062000327565b5050505050505050620003d6565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106200036a57805160ff19168380011785556200039b565b828001600101855582156200039b579182015b828111156200039a5782518255916020019190600101906200037d565b5b509050620003aa9190620003ae565b5090565b620003d391905b80821115620003cf576000816000905550600101620003b5565b5090565b90565b610fe880620003e66000396000f3fe608060405260043610610112576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806301b7dcb4146101175780631420f6691461012e5780631dd753c11461016757806332226cde1461019257806333644110146101e357806341c678a91461023a5780634f544a1314610265578063627bde92146102bc578063678cbd801461031357806377c5a846146103a35780637940ba04146103fa57806393de9e08146104495780639e56900414610474578063b4a99a4e146104cb578063b665c38414610522578063c22573371461054d578063c7c5940714610578578063db41f804146105cf578063e2d39f9e146105fe578063f1b6dccd14610629575b600080fd5b34801561012357600080fd5b5061012c610662565b005b34801561013a57600080fd5b50610143610845565b6040518082600281111561015357fe5b60ff16815260200191505060405180910390f35b34801561017357600080fd5b5061017c610858565b6040518082815260200191505060405180910390f35b34801561019e57600080fd5b506101e1600480360360208110156101b557600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919050505061085e565b005b3480156101ef57600080fd5b506101f8610aca565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561024657600080fd5b5061024f610af0565b6040518082815260200191505060405180910390f35b34801561027157600080fd5b5061027a610af6565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b3480156102c857600080fd5b506102d1610b1c565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561031f57600080fd5b50610328610b42565b6040518080602001828103825283818151815260200191508051906020019080838360005b8381101561036857808201518184015260208101905061034d565b50505050905090810190601f1680156103955780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3480156103af57600080fd5b506103b8610be0565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561040657600080fd5b506104476004803603606081101561041d57600080fd5b81019080803590602001909291908035906020019092919080359060200190929190505050610c06565b005b34801561045557600080fd5b5061045e610e68565b6040518082815260200191505060405180910390f35b34801561048057600080fd5b50610489610e6e565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b3480156104d757600080fd5b506104e0610e94565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561052e57600080fd5b50610537610eba565b6040518082815260200191505060405180910390f35b34801561055957600080fd5b50610562610ec0565b6040518082815260200191505060405180910390f35b34801561058457600080fd5b5061058d610ec6565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b3480156105db57600080fd5b506105e4610eec565b604051808215151515815260200191505060405180910390f35b34801561060a57600080fd5b50610613610eff565b6040518082815260200191505060405180910390f35b34801561063557600080fd5b5061063e610f05565b6040518082600381111561064e57fe5b60ff16815260200191505060405180910390f35b6002600381111561066f57fe5b6000809054906101000a900460ff16600381111561068957fe5b141561069457600080fd5b6003808111156106a057fe5b6000809054906101000a900460ff1660038111156106ba57fe5b14156106c557600080fd5b3373ffffffffffffffffffffffffffffffffffffffff16600060019054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415801561077157503373ffffffffffffffffffffffffffffffffffffffff16600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614155b1561077b57600080fd5b60026000806101000a81548160ff0219169083600381111561079957fe5b0217905550600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600360006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506000600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550565b600b60009054906101000a900460ff1681565b60095481565b6002600381111561086b57fe5b6000809054906101000a900460ff16600381111561088557fe5b141561089057600080fd5b60038081111561089c57fe5b6000809054906101000a900460ff1660038111156108b657fe5b14156108c157600080fd5b3373ffffffffffffffffffffffffffffffffffffffff16600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415801561096d57503373ffffffffffffffffffffffffffffffffffffffff16600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614155b1561097757600080fd5b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1614156109d257600080fd5b600060038111156109df57fe5b6000809054906101000a900460ff1660038111156109f957fe5b1415610a235760016000806101000a81548160ff02191690836003811115610a1d57fe5b02179055505b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600360006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555080600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600a5481565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600e8054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610bd85780601f10610bad57610100808354040283529160200191610bd8565b820191906000526020600020905b815481529060010190602001808311610bbb57829003601f168201915b505050505081565b600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60026003811115610c1357fe5b6000809054906101000a900460ff166003811115610c2d57fe5b1415610c3857600080fd5b600380811115610c4457fe5b6000809054906101000a900460ff166003811115610c5e57fe5b1415610c6957600080fd5b3373ffffffffffffffffffffffffffffffffffffffff16600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16141515610cc557600080fd5b80600f81905550600854831380610cdd575060075483125b15610d79576001600b60006101000a81548160ff02191690836002811115610d0157fe5b021790555082600c819055506040805190810160405280601c81526020017f48756d69646974792076616c7565206f7574206f662072616e67652e00000000815250600e9080519060200190610d58929190610f17565b506000600d60006101000a81548160ff021916908315150217905550610e23565b600a54821380610d8a575060095482125b15610e22576002600b60006101000a81548160ff02191690836002811115610dae57fe5b021790555081600c819055506040805190810160405280601f81526020017f54656d70657261747572652076616c7565206f7574206f662072616e67652e00815250600e9080519060200190610e05929190610f17565b506000600d60006101000a81548160ff0219169083151502179055505b5b60001515600d60009054906101000a900460ff1615151415610e635760036000806101000a81548160ff02191690836003811115610e5d57fe5b02179055505b505050565b600f5481565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600060019054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60075481565b60085481565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600d60009054906101000a900460ff1681565b600c5481565b6000809054906101000a900460ff1681565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610f5857805160ff1916838001178555610f86565b82800160010185558215610f86579182015b82811115610f85578251825591602001919060010190610f6a565b5b509050610f939190610f97565b5090565b610fb991905b80821115610fb5576000816000905550600101610f9d565b5090565b9056fea165627a7a72305820c35d2b4d899017c96d5de8e4275e79cfe0e63cda5109176b4e997f03a76a17a20029'

def decode_transaction_data(tx_data, contract_abi):
    method_signature = tx_data[:10]
    
   # print(method_signature)

    for item in contract_abi:
        if item["type"] == "function":
                method_id = Web3.keccak(text=f"{item['name']}({','.join([param['type'] for param in item['inputs']])})").hex()[:10]

                if method_id == method_signature:
                    contract = web3.eth.contract(abi=contract_abi)
                    decoded_inputs = contract.decode_function_input(method_signature + tx_data[10:])
                    return {
                        "function_name": item["name"],
                        "inputs": decoded_inputs
                    }
    
    return None

csv_file2 = "11_RefrigeratedTransportation.csv"
with open(csv_file2, mode="w", newline="") as file:
    writer = csv.writer(file)
    writer.writerow(["Block Number", "Tx Hash", "From", "To", "Value", "Data","Deocde_data"])


import pandas as pd
pd_data = pd.read_csv('all_txn.csv')

for index, data in enumerate(data_column, start=1):
    Decode_data = (decode_transaction_data(data,contract_abi))
    if Decode_data != None:
         print(index)
         with open(csv_file2, mode="a", newline="") as file:
            writer = csv.writer(file)
            writer.writerow([pd_data.at[index, "Block Number"], pd_data.at[index, "Tx Hash"], pd_data.at[index, "From"], pd_data.at[index, "To"], pd_data.at[index, "Value"], pd_data.at[index, "Data"],Decode_data])
         
